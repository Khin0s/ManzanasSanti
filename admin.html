<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrador</title>
    <link rel="website icon" type="icon" href="./img/icon3.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="./Css/estilos.css">
    
</head>
<body>
    <header>
        <img class="banner" src="/img/bannerRe.png" alt="#">
        <div class="d-flex">
        <button id="btnCerrarSesion" class="btn btn-secondary btn-lg">CERRAR SESION</button>
        
    </div>
    </header>
    <H1>BIENVENIDO ADMINISTRAD@R: <span id="nombreUsuario"></span></H1>
    <button id="btnUsuarios" class="btn btn-outline-secondary">Visualizar Usuarios</button>
    <button id="btnManzanas" class="btn btn-outline-secondary">Visualizar Manzanas</button>
    <button id="btnServicios" class="btn btn-outline-secondary">Visualizar Servicios</button>
    <br>
    <br>
    <div id="tablausuarios" style="display: none;" class="w-100">
        <h2>Usuarios-Registrados</h2>
        <br>
        <table id="tabla-visualizar-usuarios" class="table table-striped-columns">
            <thead>
            <tr>
                <th>Id</th>
                <th>Nombre</th>
                <th>Tipo</th>
                <th>Documento</th>
                <th>ID manzanas</th>
            </tr>
        </thead>
        <tbody id="lista-usuarios"></tbody>
        </table>
    </div>
    <div id="tablaManzanas" style="display: none;">
        <h2>Manzanas</h2>

        <table id="tabla-visualizar-manzanas" class="table table-striped-columns">
            <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Direccion</th>
            </tr>
        </thead>
        <tbody id="lista-manzanas"></tbody>
        </table>
        <a href="./Nuevamanzana.html"><button>Crear Nueva Manzana</button></a>
        </div>

        <div id="servicios-guardados-container" class="w-25" style="display: none;">
            <center><h2>Servicios Guardados</h2></center> 
             <table id="tabla-servicios-guardados"  class="table table-success table-striped-columns">
               <thead>
                 <tr>
                   <th>Servicio</th>
                   <th>Fecha</th>
                   <th>Eliminar</th>
                 </tr>
               </thead>
               <tbody id="lista-servicios-guardados"></tbody>
             </table>
           </div>


    
    <script>
        document.addEventListener('DOMContentLoaded',()=>{
            const xhrUsuario =new XMLHttpRequest();
        xhrUsuario.open('POST', '/obtener-usuario',true);
        xhrUsuario.onreadystatechange=function(){
            if(xhrUsuario.readyState==4){
                if(xhrUsuario.status==200){
                    const usuario= JSON.parse(xhrUsuario.responseText);
                    document.getElementById('nombreUsuario').textContent=usuario.nombre;
                }
                else{
                    console.error('error al obtener el usuario')
                }
            }
        };
        xhrUsuario.send();

        const tablausuarios = document.getElementById('tablausuarios');
        const TablaVisualizarUsuario = document.getElementById('tabla-visualizar-usuarios');
        const btnUsuarios = document.getElementById('btnUsuarios');
        const listausuarios = document.getElementById('lista-usuarios')

        const tablaManzanas = document.getElementById('tablaManzanas');
        const TablaVisualizarManzanas = document.getElementById('tabla-visualizar-manzanas');
        const btnManzanas = document.getElementById('btnManzanas');
        const listamanzanas = document.getElementById('lista-manzanas');

        const btnServicios = document.getElementById('btnServicios');
        const serviciosGuardadosContainer = document.getElementById('servicios-guardados-container')
        const listaServiciosGuardados = document.getElementById('lista-servicios-guardados');

        //obtener usuarios
        btnUsuarios.addEventListener('click',()=>{
            if(tablausuarios.style.display === 'block'){
                tablausuarios.style.display = 'none';}
                else{
            const xhrObtenerUsuario = new XMLHttpRequest();
            xhrObtenerUsuario.open('POST', '/mostrar-usuarios', true);
            xhrObtenerUsuario.setRequestHeader('Content-Type', 'application/json');
            xhrObtenerUsuario.onreadystatechange=function(){
                if(xhrObtenerUsuario.readyState===4){
                    if(xhrObtenerUsuario.status===200){
                        const data = JSON.parse(xhrObtenerUsuario.responseText)
                        listausuarios.innerHTML = '';
                        data.usuarios.map(usuario => {
                            const row=document.createElement('tr');
                            row.innerHTML=
                            `<td>${usuario.id_user}</td>
                            <td>${usuario.Nombre}</td>
                            <td>${usuario.Tipo}</td>
                            <td>${usuario.Documento}</td>
                            <td>${usuario.id_manzanas }</td>
                            <td><button class="btn btn-info" onclick="editarUsuario(${usuario})">Editar</button></td>
                            <td><button class="btn btn-danger" onclick="eliminarUsuario(${usuario.id_user})">Eliminar</button></td>
                            
                            `
                            TablaVisualizarUsuario.appendChild(row);
                        });
                        tablausuarios.style.display = "block";
                    }
                    else{
                        console.error('error al obtener usuario')
                    }
                }
            }
            xhrObtenerUsuario.send();
        }
        })
        

//eliminar usuarios
function eliminarUsuario(id_user){
    const xhrEliminarUsuario = new XMLHttpRequest();
    xhrEliminarUsuario.open('DELETE', `/eliminar-usuario/${id_user}`,true);
    xhrEliminarUsuario.setRequestHeader('Content-Type', 'application/json');
    xhrEliminarUsuario.onreadystatechange=function(){
        if(xhrEliminarUsuario.readyState===4 && xhrEliminarUsuario.status===200){
            alert("Usuario Eliminado");
            window.location.reload();
        }
        else{
                console.error('error al eliminar el servicio');
            }
    }
    xhrEliminarUsuario.send();
}

btnManzanas.addEventListener('click',()=>{
            const xhrObtenerManzanas = new XMLHttpRequest();
            xhrObtenerManzanas.open('POST', '/mostrar-manzanas', true);
            xhrObtenerManzanas.setRequestHeader('Content-Type', 'application/json');
            xhrObtenerManzanas.onreadystatechange=function(){
                if(xhrObtenerManzanas.readyState===4){
                    if(xhrObtenerManzanas.status===200){
                        const data2 = JSON.parse(xhrObtenerManzanas.responseText)
                        listamanzanas.innerHTML = '';
                        data2.manzanas.map(manzana=>{
                            const row=document.createElement('tr');
                            row.innerHTML=
                            `
                            <td>${manzana.id_manzanas}</td>
                            <td>${manzana.Nombre}</td>
                            <td>${manzana.Direccion}</td>
                            <td><button class="actualizarmanzana" onclick="actualizarmanzana(${manzana})">Actualizar</button></td>
                            
                            `
                            TablaVisualizarManzanas.appendChild(row);
                        });
                        tablaManzanas.style.display = 'block'
                    } else{
                        console.error('error al obtener manzanas')
                    }
                }

            }
            xhrObtenerManzanas.send();

        })


        //visualizar servicios

        btnServicios.addEventListener('click', ()=>{
            const xhrObtenerServiciosGuardados = new XMLHttpRequest();
            xhrObtenerServiciosGuardados.open('POST','/obtener-servicios-guardados-admi',true);
            xhrObtenerServiciosGuardados.onreadystatechange=function(){
                if(xhrObtenerServiciosGuardados.readyState==4){
                    if(xhrObtenerServiciosGuardados.status===200){
                        const data=JSON.parse(xhrObtenerServiciosGuardados.responseText);
                        listaServiciosGuardados.innerHTML =""
                        data.serviciosGuardados.map(servicio=>
                        `
                        <tr>
                            <td>${servicio.Nombre}</td>
                            <td>${new Date (servicio.fecha).toUTCString()}</td>
                            <td><button class="btn btn-danger" onclick="eliminarServicio(${servicio.id})">Eliminar</button></td>
                        </tr>
                        `).join('');


                    serviciosGuardadosContainer.style.display='block';
                    } else{
                        console.error('error al obtener servicios guardados')
                    }
                }
            }
            xhrObtenerServiciosGuardados.send();
        });

        const btnCerrarSesion =document.getElementById('btnCerrarSesion');
        btnCerrarSesion.addEventListener('click',()=>{
            const xhrCerrarSesion = new XMLHttpRequest();
            xhrCerrarSesion.open('POST','/cerrar-sesion',true);
            xhrCerrarSesion.onreadystatechange=function(){
                if(xhrCerrarSesion.readyState===4 && xhrCerrarSesion.status===200){
                    window.location.href= '/index.html';
            }
            else{
                        console.error('error al cerrar sesion')
                    }
        }
        xhrCerrarSesion.send();
    })
    //no permite ir hacia atras
    window.onload=function(){
        window.history.forward();
    };
    //caundo va hacia atras se recarga la pagina
    window.onpageshow=function(evento){
        if(evento.persisted){
            window.location.reload();
        }
    }
})


    </script>
</body>
</html>